name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  actions: read
  checks: write  # Required for test-reporter

env:
  DOTNET_VERSION: '9.0.x'
  BUILD_CONFIGURATION: 'Release'
  APP_VERSION: '1.1.3'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore

    - name: Build framework-dependent
      run: dotnet build --no-restore --configuration ${{ env.BUILD_CONFIGURATION }}

    - name: Run tests
      run: dotnet test --no-build --verbosity normal --configuration ${{ env.BUILD_CONFIGURATION }} --logger trx --results-directory TestResults

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Test Results
        path: TestResults/*.trx
        reporter: dotnet-trx

    - name: Build self-contained
      run: dotnet publish WallpaperChanger --configuration ${{ env.BUILD_CONFIGURATION }} --self-contained true --runtime win-x64 --output publish

    - name: Upload framework-dependent build
      uses: actions/upload-artifact@v4
      with:
        name: WallpaperChanger-framework-dependent
        path: |
          WallpaperChanger/bin/Release/net9.0-windows/
          !WallpaperChanger/bin/Release/net9.0-windows/ref/

    - name: Upload self-contained build
      uses: actions/upload-artifact@v4
      with:
        name: WallpaperChanger-self-contained
        path: publish/

  build-installer:
    name: Build Inno Setup Installer
    runs-on: windows-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download self-contained build
      uses: actions/download-artifact@v4
      with:
        name: WallpaperChanger-self-contained
        path: publish/

    - name: Install Inno Setup
      shell: pwsh
      run: |
        # Download and install Inno Setup
        $innoSetupUrl = "https://jrsoftware.org/download.php/is.exe"
        $installerPath = "$env:TEMP\innosetup.exe"

        Write-Host "Downloading Inno Setup..."
        Invoke-WebRequest -Uri $innoSetupUrl -OutFile $installerPath

        Write-Host "Installing Inno Setup..."
        Start-Process -FilePath $installerPath -Args "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait

        Write-Host "Inno Setup installed successfully"

    - name: Build Inno Setup installer
      shell: pwsh
      run: |
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (-not (Test-Path $isccPath)) {
          Write-Error "ISCC.exe not found at $isccPath"
          exit 1
        }

        Write-Host "Building Inno Setup installer..."
        & $isccPath "WallpaperChanger.iss"

        if ($LASTEXITCODE -ne 0) {
          Write-Error "Inno Setup build failed"
          exit 1
        }

        Write-Host "Inno Setup installer built successfully"

    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: WallpaperChanger-installer
        path: installer/output/InnoSetup/*.exe
